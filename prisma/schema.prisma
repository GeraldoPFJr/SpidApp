generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Catalogos ───────────────────────────────────────────

model Category {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  subcategories Subcategory[]
  products      Product[]

  @@map("categories")
}

model Subcategory {
  id         String   @id @default(uuid())
  categoryId String   @map("category_id")
  name       String
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  category Category  @relation(fields: [categoryId], references: [id])
  products Product[]

  @@map("subcategories")
}

model Product {
  id            String    @id @default(uuid())
  name          String
  code          String?
  categoryId    String    @map("category_id")
  subcategoryId String?   @map("subcategory_id")
  minStock      Int?      @map("min_stock")
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  category    Category     @relation(fields: [categoryId], references: [id])
  subcategory Subcategory? @relation(fields: [subcategoryId], references: [id])

  units      ProductUnit[]
  prices     ProductPrice[]
  movements  InventoryMovement[]
  costLots   CostLot[]
  saleItems  SaleItem[]
  purchaseItems PurchaseItem[]

  @@map("products")
}

model ProductUnit {
  id           String   @id @default(uuid())
  productId    String   @map("product_id")
  nameLabel    String   @map("name_label")
  factorToBase Int      @map("factor_to_base")
  isSellable   Boolean  @map("is_sellable")
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id])

  prices        ProductPrice[]
  saleItems     SaleItem[]
  purchaseItems PurchaseItem[]

  @@map("product_units")
}

model PriceTier {
  id        String   @id @default(uuid())
  name      String
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  prices ProductPrice[]

  @@map("price_tiers")
}

model ProductPrice {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  unitId    String   @map("unit_id")
  tierId    String   @map("tier_id")
  price     Decimal  @db.Decimal(12, 2)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  product Product     @relation(fields: [productId], references: [id])
  unit    ProductUnit @relation(fields: [unitId], references: [id])
  tier    PriceTier   @relation(fields: [tierId], references: [id])

  @@index([productId, tierId, unitId])
  @@map("product_prices")
}

// ─── Mestres ─────────────────────────────────────────────

model Customer {
  id        String    @id @default(uuid())
  name      String
  phone     String?
  doc       String?
  address   String?
  notes     String?
  type      String    @default("PF") // PF | PJ
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  sales       Sale[]
  receivables Receivable[]

  @@map("customers")
}

model Supplier {
  id           String    @id @default(uuid())
  name         String
  phone        String?
  cnpj         String?
  city         String?
  productTypes String?   @map("product_types")
  minOrder     String?   @map("min_order")
  paymentTerms String?   @map("payment_terms")
  notes        String?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  purchases Purchase[]

  @@map("suppliers")
}

// ─── Compras ─────────────────────────────────────────────

model Purchase {
  id         String   @id @default(uuid())
  supplierId String   @map("supplier_id")
  date       DateTime
  notes      String?
  status     String   @default("CONFIRMED")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  supplier Supplier @relation(fields: [supplierId], references: [id])

  items    PurchaseItem[]
  costs    PurchaseCost[]
  payments Payment[]

  @@index([date])
  @@index([supplierId])
  @@map("purchases")
}

model PurchaseItem {
  id         String   @id @default(uuid())
  purchaseId String   @map("purchase_id")
  productId  String   @map("product_id")
  unitId     String   @map("unit_id")
  qty        Int
  unitCost   Decimal  @map("unit_cost") @db.Decimal(12, 2)
  totalCost  Decimal  @map("total_cost") @db.Decimal(12, 2)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  purchase Purchase    @relation(fields: [purchaseId], references: [id])
  product  Product     @relation(fields: [productId], references: [id])
  unit     ProductUnit @relation(fields: [unitId], references: [id])

  costLots CostLot[]

  @@map("purchase_items")
}

model PurchaseCost {
  id         String   @id @default(uuid())
  purchaseId String   @map("purchase_id")
  label      String
  amount     Decimal  @db.Decimal(12, 2)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  purchase Purchase @relation(fields: [purchaseId], references: [id])

  @@map("purchase_costs")
}

// ─── Estoque ─────────────────────────────────────────────

model InventoryMovement {
  id         String   @id @default(uuid())
  productId  String   @map("product_id")
  date       DateTime
  direction  String   // IN | OUT
  qtyBase    Int      @map("qty_base")
  reasonType String   @map("reason_type")
  reasonId   String?  @map("reason_id")
  notes      String?
  deviceId   String   @map("device_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id])

  @@index([productId, date])
  @@map("inventory_movements")
}

model CostLot {
  id               String   @id @default(uuid())
  productId        String   @map("product_id")
  purchaseItemId   String   @map("purchase_item_id")
  qtyRemainingBase Int      @map("qty_remaining_base")
  unitCostBase     Decimal  @map("unit_cost_base") @db.Decimal(12, 6)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  product      Product      @relation(fields: [productId], references: [id])
  purchaseItem PurchaseItem @relation(fields: [purchaseItemId], references: [id])

  @@map("cost_lots")
}

// ─── Vendas ──────────────────────────────────────────────

model Sale {
  id           String   @id @default(uuid())
  customerId   String?  @map("customer_id")
  date         DateTime
  status       String   @default("DRAFT") // DRAFT | CONFIRMED | CANCELLED
  subtotal     Decimal  @db.Decimal(12, 2)
  discount     Decimal  @default(0) @db.Decimal(12, 2)
  surcharge    Decimal  @default(0) @db.Decimal(12, 2)
  freight      Decimal  @default(0) @db.Decimal(12, 2)
  total        Decimal  @db.Decimal(12, 2)
  couponNumber Int?     @map("coupon_number")
  notes        String?
  deviceId     String   @map("device_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  customer Customer? @relation(fields: [customerId], references: [id])

  items       SaleItem[]
  payments    Payment[]
  receivables Receivable[]

  @@index([date])
  @@index([customerId])
  @@index([status])
  @@map("sales")
}

model SaleItem {
  id        String   @id @default(uuid())
  saleId    String   @map("sale_id")
  productId String   @map("product_id")
  unitId    String   @map("unit_id")
  qty       Int
  unitPrice Decimal  @map("unit_price") @db.Decimal(12, 2)
  total     Decimal  @db.Decimal(12, 2)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  sale    Sale        @relation(fields: [saleId], references: [id])
  product Product     @relation(fields: [productId], references: [id])
  unit    ProductUnit @relation(fields: [unitId], references: [id])

  @@map("sale_items")
}

// ─── Recebiveis ──────────────────────────────────────────

model Receivable {
  id         String   @id @default(uuid())
  saleId     String?  @map("sale_id")
  customerId String   @map("customer_id")
  dueDate    DateTime @map("due_date")
  amount     Decimal  @db.Decimal(12, 2)
  status     String   @default("OPEN") // OPEN | PAID | CANCELLED
  kind       String   // CREDIARIO | BOLETO | CHEQUE | CARD_INSTALLMENT
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  sale     Sale?    @relation(fields: [saleId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])

  settlements ReceivableSettlement[]

  @@index([status, dueDate])
  @@index([customerId])
  @@map("receivables")
}

model ReceivableSettlement {
  id           String   @id @default(uuid())
  receivableId String   @map("receivable_id")
  paymentId    String   @map("payment_id")
  amount       Decimal  @db.Decimal(12, 2)
  paidAt       DateTime @map("paid_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  receivable Receivable @relation(fields: [receivableId], references: [id])
  payment    Payment    @relation(fields: [paymentId], references: [id])

  @@map("receivable_settlements")
}

// ─── Pagamentos ──────────────────────────────────────────

model Payment {
  id           String   @id @default(uuid())
  saleId       String?  @map("sale_id")
  purchaseId   String?  @map("purchase_id")
  date         DateTime
  method       String   // CASH | PIX | CREDIT_CARD | DEBIT_CARD | CREDIARIO | BOLETO | CHEQUE
  amount       Decimal  @db.Decimal(12, 2)
  accountId    String   @map("account_id")
  cardType     String?  @map("card_type")
  installments Int?
  notes        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  sale     Sale?    @relation(fields: [saleId], references: [id])
  purchase Purchase? @relation(fields: [purchaseId], references: [id])
  account  Account  @relation(fields: [accountId], references: [id])

  settlements ReceivableSettlement[]

  @@map("payments")
}

// ─── Financeiro ──────────────────────────────────────────

model Account {
  id        String   @id @default(uuid())
  name      String
  type      String   // CASH | BANK | OTHER
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  payments        Payment[]
  financeEntries  FinanceEntry[]
  monthlyClosures MonthlyClosure[]

  @@map("accounts")
}

model FinanceCategory {
  id        String   @id @default(uuid())
  type      String   // EXPENSE | INCOME
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  entries FinanceEntry[]

  @@map("finance_categories")
}

model FinanceEntry {
  id         String    @id @default(uuid())
  type       String    // EXPENSE | INCOME | APORTE | RETIRADA | TRANSFER
  categoryId String?   @map("category_id")
  accountId  String    @map("account_id")
  amount     Decimal   @db.Decimal(12, 2)
  dueDate    DateTime? @map("due_date")
  status     String    @default("SCHEDULED") // SCHEDULED | DUE | PAID | CANCELLED
  paidAt     DateTime? @map("paid_at")
  notes      String?
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  category FinanceCategory? @relation(fields: [categoryId], references: [id])
  account  Account          @relation(fields: [accountId], references: [id])

  @@map("finance_entries")
}

model MonthlyClosure {
  id              String   @id @default(uuid())
  month           String   // YYYY-MM
  accountId       String   @map("account_id")
  openingBalance  Decimal  @map("opening_balance") @db.Decimal(12, 2)
  expectedClosing Decimal  @map("expected_closing") @db.Decimal(12, 2)
  countedClosing  Decimal? @map("counted_closing") @db.Decimal(12, 2)
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  account Account @relation(fields: [accountId], references: [id])

  @@map("monthly_closures")
}

// ─── Offline/Sync ────────────────────────────────────────

model OutboxOperation {
  id          String    @id @default(uuid())
  operationId String    @unique @map("operation_id")
  entityType  String    @map("entity_type")
  action      String
  payload     Json
  syncedAt    DateTime? @map("synced_at")
  deviceId    String    @map("device_id")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("outbox_operations")
}

model SyncCursor {
  id         String   @id @default(uuid())
  deviceId   String   @unique @map("device_id")
  lastCursor DateTime @map("last_cursor")

  @@map("sync_cursors")
}
